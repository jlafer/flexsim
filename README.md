# flexsim
This project is a Twilio Flex activity simulator.

This tool can generate a pseudo-random Flex configuration, deploy Flex infrastructure into a Twilio project, simulate a customer workload and the handling of the workload, thus simulating the activity one might expect to see in a customer environment. The activity can then be used for a few different purposes: demos of realtime dashboards; generation of data for Flex Insights demos; testing of TR workflows; and feeding semi-realistic events to EventStreams.

The system is composed of multiple, independent components: configuration generator, infrastructure deployer, customer simulator and agent simulator. There is also a cleanup script to remove in-process tasks and, optionally, the deployed resources from a Flex project.

## genconfig
The configuration generator script reads a simulation domain description and produces configuration files as output. It is used at simulation design time and only needs to run when the domain description has changed. The domain description and/or configuration files can be checked into source control and shared among users. The script does not require a Twilio project to execute and the configuration files contain no Twilio SIDs that tie them to a specific project.

## deploy
The infrastructure deployment script reads the configuration files and executes against a specific Twilio Flex project. It is used at deployment time and only needs to run when the project is out of sync with the configuration files, such as if they have been regenerated by `genconfig`.

Deployment consists of building Workers, TaskQueues and a Workflow. It does not touch any resources created outside of the `flexsim` configuration, so you can deploy into an existing Flex project without explicit conflicts.

NOTE: Care must be taken when other tasks are being routed in the project to ensure they are not handled by `flexsim` agents. Conversely, tasks generated by `flexsim` could be routed to your other Workers if the routing criteria overlap. This could be what you want if, for example, you want to login to Flex and handle tasks generated by the simulator.

## agentsim
The agent simulator script reads the configuration files, performs a login of the `flexsim` agents and makes them Available for work. When TaskRouter assigns them a Task, they "handle" it. It can run in any Flex project that has infrastructure in sync with the configuration files. It can run in the background during the presentation of a demo using that project.

## custsim
The customer simulator script reads the configuration files and generates Tasks that are then routed to the simulation agents. The configuration files control the arrival rate, channels, customer intents and other parameters. Most behaviors are semi-random, meaning they have targets but can vary in a pseudo-random fashion around their target.

## Configuration
The system has four execution modes: configuration generation, infrastructure deployment, simulation and (as needed) cleanup. The configuration generation mode uses a combination of default values and user-supplied inputs to generate a set of JSON configuration files. The deployment, simulation and cleanup modules then read the configuration files when executing against a Flex project.

### Defaults
For ease of use, the configuration generator can be run without any input from the user, simply by relying on default domain values. This will support a bare-bones, generic simulation environment. The default values have been chosen to best support a typical SE-led customer demo. They are not very realistic but they do make for a lively demo in the Flex realtime dashboards. Thus, the defaults may not be appropriate for other use cases.

The defaults have been localized for US English and are read (by default) from a file at `domain/en-us.json`. The `flexsim` system can be localized for a different locale by creation of a different defaults file, which can be specified using the `--locale` option to the `genconfig` script.

The default values can then be overridden by the user using a combination of a `domain.json` file and command-line options. It then uses the combination of those values to generate the configuration files used during the other modes of operation.

### domain.json
For saving a custom simulation domain description, the user can provision a file, named `domain.json`. The `genconfig` script can read this file and generate configuration files based on the description there.  This allows the user to control nearly every aspect of the resulting simulation: tasks, channels, agent counts, customer intents, routing criteria, handle times, agent activities, etc.

The format of the file is not yet documented in this README. However, you can inspect the `src/helpers/schema.js` file to see a JSON Schema definition for the file. You can also inspect the `domain.json` file in the project root folder for an example. These two should get the early adopter started. :-)

### Command-line Options
Each `flexsim` script supports a set of command-line options, which can be used to make dynamic changes to its operation. Most of these relate to Flex credentials, file locations, task volumes, agent counts and other quantitative aspects of the simulation.
 
### Environment Variables
The scripts that use a Twilio project can use the following environment variables to reference that project and Workspace:
- ACCOUNT_SID
- AUTH_TOKEN
- WRKSPC_SID

The `agentsim` script also accepts a variable to specify the HTTP listening port.
- AGENTSIM_PORT

A `.env` file placed in the project root folder can be used to supply those variables to all scripts. See `.env.sample` for a template.

### Preparing a Flex Project for flexsim

#### Task Channels
If you specify any non-standard channels in your domain, make sure the corresponding TaskChannels have been created in the target Flex project prior to running `custsim`. 

#### Worker Activities
If you specify any non-standard Worker activities in your domain, make sure they have been created in the target Flex project prior to running `agentsim`.

#### Skills
To avoid conflicts with the existing configuration of your target Flex project, the `deploy` script doesn't build out the list of possible `routing.skills` values nor the proficiencies. Thus, you should use the Flex Admin page, under the Skills menu choice, to define any of the skills that can be assigned to agents. By default these are: "Sales", "Service" and "Support".

## Script Execution
In the project directory, there are five NodeJS scripts. See the `execution.txt` file in the project root directory for sample command lines to run these scripts.

### genconfig
To start the `genconfig` script:
```
node ./src/deploy [--domaindir dir] [--cfgdir dir] [--locale]
```
The optional command-line options include:
- `domaindir` specifies the directory where the `domain.json` file, if any, is located
- `cfgdir` specifies the directory where the configuration files should be written
- `locale` specifies the name of a JSON file containing localized domain default values

### deploy
To start the `deploy` script:
```
node ./src/deploy [--cfgdir dir] [--acct ACxxx] [--auth abcde] [--wrkspc WSxxxx] [--assignURL url]
```
The optional command-line options include:
- `cfgdir` specifies the directory where the configuration files to be read are located
- `assignURL` specifies the ssignment callback URL to be written into the generated Workflow; this should refer to the `agentsim` host and listening port

- Authentication credentials can also be supplied via the command line, overriding any found in the environment.


### agentsim
`agentsim` is an Express server that handles tasks in a specific Twilio project and TR workspace.

Currently, `agentsim` must be started and the agents should be signed-in before `custsim`.

It supports a single URL path:
- `/reservation` is called by the TR assignment callback to request acceptance of the task by a specific agent. The script uses this request to trigger simulated handling of each task.

To start the `agentsim` script:
```
node ./src/agentsim [--cfgdir dir] [--acct ACxxx] [--auth abcde] [--wrkspc WSxxxx] [--port num]
```
The optional command-line options include:
- `cfgdir` specifies the directory where the configuration files to be read are located
- `port` specifies the HTTP port on which the program listens for callbacks from TaskRouter; if not specified here or in the environment, the default is 3000

- Authentication credentials can also be supplied via the command line, overriding any found in the environment.

#### agentsim must be publicly accessible
The simulation builds and deploys a TR Workflow that uses the configured Task attributes, routing criteria and Worker attributes to select and reserve the `flexsim` agents. When a reservation is made, Twilio calls the Workflow-specified assignment callback URL, in order to let the `agentsim` program know that an agent has been assigned a task and that it should now start "handling" the task. That URL can be configured by the user and must reference the host and port of the `agentsim` script, which must be publicly accessible. On a development machine, this can be done using a tunnel service like `ngrok`.

### custsim
To start the `custsim` script:
```
node ./src/custsim [--cfgdir dir] [--acct ACxxx] [--auth abcde] [--wrkspc WSxxxx]
```
The optional command-line options include:
- `cfgdir` specifies the directory where the configuration files to be read are located

- Authentication credentials can also be supplied via the command line, overriding any found in the environment.


### cleansim
To start the `cleansim` script:
```
node ./src/cleansim [--cfgdir dir] [--acct ACxxx] [--auth abcde] [--wrkspc WSxxxx]
```
The optional command-line options include:
- `cfgdir` specifies the directory where the configuration files to be read are located

- Authentication credentials can also be supplied via the command line, overriding any found in the environment.

## Using flexsim in a Demo
When using `flexsim` in a demo, here are some tips:
- All simulated agents start out in an Available state and it takes awhile for the random nature of the simulation to place agents in a mixture of activities that is both realistic and in line with the configured value-percentages. Thus, start `agentsim` at least 10 minutes before your demo.

## Changelog

### 0.0.1
- This is the initial "beta" release for SE testing.
